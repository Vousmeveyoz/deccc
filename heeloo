--[[
    ANTI-CHEAT UNTUK MUSIC SYSTEM & ADMIN REMOTES
    Berdasarkan hasil testing yang ditemukan
    
    CELAH YANG DITEMUKAN:
    - 10 Music/Audio remotes yang bisa di-abuse
    - 13 Admin remotes yang perlu protection
    - 1 Ban remote yang perlu security
    
    INSTALL: Paste di ServerScriptService
]]

local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ============================================
-- KONFIGURASI
-- ============================================

local CONFIG = {
    -- Rate limiting
    MAX_REQUESTS_PER_SECOND = 3,  -- Untuk music remotes
    MUSIC_COOLDOWN = 2,  -- Cooldown antar music command (detik)
    
    -- Auto-kick
    AUTO_KICK = true,
    MAX_VIOLATIONS = 5,
    
    -- Admin whitelist
    ADMIN_USER_IDS = {
        -- TAMBAHKAN USER ID ADMIN DI SINI!
        -- 123456789,
        -- 987654321,
    },
    
    -- Logging
    ENABLE_LOGGING = true,
}

-- ============================================
-- TRACKING
-- ============================================

local PlayerData = {}

local function GetPlayerData(player)
    if not PlayerData[player] then
        PlayerData[player] = {
            RequestCount = 0,
            LastRequestTime = 0,
            Violations = 0,
            LastMusicAction = 0,
            MusicActionsCount = 0,
        }
    end
    return PlayerData[player]
end

local function Log(message, level)
    if CONFIG.ENABLE_LOGGING then
        local prefix = level == "WARN" and "‚ö†Ô∏è" or level == "ERROR" and "üö´" or level == "KICK" and "üë¢" or "‚ÑπÔ∏è"
        print(string.format("[ANTI-CHEAT] %s %s", prefix, message))
    end
end

-- ============================================
-- VALIDATION FUNCTIONS
-- ============================================

local function IsAdmin(player)
    -- Check if player is admin
    if player.UserId == game.CreatorId then
        return true
    end
    
    for _, adminId in pairs(CONFIG.ADMIN_USER_IDS) do
        if player.UserId == adminId then
            return true
        end
    end
    
    return false
end

local function CheckRateLimit(player)
    local data = GetPlayerData(player)
    local now = tick()
    
    if now - data.LastRequestTime >= 1 then
        data.RequestCount = 0
        data.LastRequestTime = now
    end
    
    data.RequestCount = data.RequestCount + 1
    
    if data.RequestCount > CONFIG.MAX_REQUESTS_PER_SECOND then
        data.Violations = data.Violations + 1
        Log(string.format("%s spam requests! (%d/s)", player.Name, data.RequestCount), "WARN")
        return false
    end
    
    return true
end

local function CheckMusicCooldown(player)
    local data = GetPlayerData(player)
    local now = tick()
    
    if now - data.LastMusicAction < CONFIG.MUSIC_COOLDOWN then
        data.Violations = data.Violations + 1
        Log(string.format("%s spam music commands!", player.Name), "WARN")
        return false
    end
    
    data.LastMusicAction = now
    return true
end

local function HandleViolation(player)
    local data = GetPlayerData(player)
    
    if data.Violations >= CONFIG.MAX_VIOLATIONS then
        Log(string.format("KICKING %s - Violations: %d", player.Name, data.Violations), "KICK")
        
        if CONFIG.AUTO_KICK then
            player:Kick("‚ö†Ô∏è Anti-Cheat: Terdeteksi spam/abuse remotes")
        end
    end
end

-- ============================================
-- PROTECT MUSIC SYSTEM
-- ============================================

local function ProtectMusicSystem()
    Log("üéµ Protecting Music System...", "INFO")
    
    local songSystem = ReplicatedStorage:FindFirstChild("SongSystem")
    if not songSystem then
        Log("SongSystem tidak ditemukan!", "WARN")
        return
    end
    
    local events = songSystem:FindFirstChild("Events")
    if not events then
        Log("SongSystem.Events tidak ditemukan!", "WARN")
        return
    end
    
    -- Remote yang perlu di-protect berdasarkan hasil testing
    local musicRemotes = {
        "PauseSong",
        "NextSong",
        "PreviousSong",
        "ToggleAutoPlay",
        "UpdateNowPlaying",
        "UpdateAutoPlayState",
        "PlaySong",
        "AddToQueue",
        "UpdateQueue",
    }
    
    for _, remoteName in pairs(musicRemotes) do
        local remote = events:FindFirstChild(remoteName)
        if remote and remote:IsA("RemoteEvent") then
            -- Disconnect old connections (optional)
            -- remote.OnServerEvent:Clear()
            
            remote.OnServerEvent:Connect(function(player, ...)
                -- Rate limit check
                if not CheckRateLimit(player) then
                    HandleViolation(player)
                    return
                end
                
                -- Music cooldown check
                if not CheckMusicCooldown(player) then
                    HandleViolation(player)
                    return
                end
                
                -- Jika lolos, biarkan event handler asli yang process
                Log(string.format("%s used %s", player.Name, remoteName), "INFO")
            end)
            
            Log(string.format("‚úÖ Protected: %s", remoteName), "INFO")
        end
    end
end

-- ============================================
-- PROTECT MUSIC REMOTES (MusicBroadcast, MusicUpdate)
-- ============================================

local function ProtectMusicRemotes()
    Log("üéµ Protecting MusicRemotes...", "INFO")
    
    local musicRemotes = ReplicatedStorage:FindFirstChild("MusicRemotes")
    if not musicRemotes then
        Log("MusicRemotes tidak ditemukan!", "WARN")
        return
    end
    
    local remotes = {"MusicBroadcast", "MusicUpdate"}
    
    for _, remoteName in pairs(remotes) do
        local remote = musicRemotes:FindFirstChild(remoteName)
        if remote and remote:IsA("RemoteEvent") then
            remote.OnServerEvent:Connect(function(player, ...)
                -- Only admin can broadcast music
                if not IsAdmin(player) then
                    local data = GetPlayerData(player)
                    data.Violations = data.Violations + 2
                    Log(string.format("%s tried to use %s without admin!", player.Name, remoteName), "ERROR")
                    HandleViolation(player)
                    return
                end
                
                Log(string.format("Admin %s used %s", player.Name, remoteName), "INFO")
            end)
            
            Log(string.format("‚úÖ Protected (Admin Only): %s", remoteName), "INFO")
        end
    end
end

-- ============================================
-- PROTECT ADMIN REMOTES
-- ============================================

local function ProtectAdminRemotes()
    Log("üëë Protecting Admin Remotes...", "INFO")
    
    local adminRemotes = ReplicatedStorage:FindFirstChild("AdminRemotes")
    if adminRemotes then
        -- Protect semua admin remotes
        for _, remote in pairs(adminRemotes:GetDescendants()) do
            if remote:IsA("RemoteEvent") then
                remote.OnServerEvent:Connect(function(player, ...)
                    if not IsAdmin(player) then
                        local data = GetPlayerData(player)
                        data.Violations = data.Violations + 5  -- Serious violation
                        Log(string.format("%s tried ADMIN remote: %s", player.Name, remote.Name), "ERROR")
                        HandleViolation(player)
                        return
                    end
                    
                    Log(string.format("Admin %s used %s", player.Name, remote.Name), "INFO")
                end)
                
                Log(string.format("‚úÖ Protected Admin Remote: %s", remote.Name), "INFO")
            end
        end
    end
    
    -- Protect specific admin remotes yang ditemukan
    local specificAdminRemotes = {
        "Announcement",
        "AdminAccess",
        "GiveRoleRemote",
        "GiveGamePass",
        "SendAnnouncement",
        "OpenAnnouncementGUI",
        "GlobalAnnouncementEvent",
        "RefreshRole",
        "BannedUsers",
    }
    
    for _, remoteName in pairs(specificAdminRemotes) do
        local remote = ReplicatedStorage:FindFirstDescendant(remoteName)
        if remote and remote:IsA("RemoteEvent") then
            remote.OnServerEvent:Connect(function(player, ...)
                if not IsAdmin(player) then
                    local data = GetPlayerData(player)
                    data.Violations = data.Violations + 5
                    Log(string.format("%s tried admin command: %s", player.Name, remoteName), "ERROR")
                    HandleViolation(player)
                    
                    -- Instant kick untuk admin commands
                    if CONFIG.AUTO_KICK then
                        player:Kick("üö´ Unauthorized admin access attempt")
                    end
                    return
                end
                
                Log(string.format("Admin %s used %s", player.Name, remoteName), "INFO")
            end)
            
            Log(string.format("‚úÖ Protected: %s", remoteName), "INFO")
        end
    end
end

-- ============================================
-- PROTECT GAMEPASS REMOTES
-- ============================================

local function ProtectGamepassRemotes()
    Log("üíé Protecting Gamepass Remotes...", "INFO")
    
    local gamepass = ReplicatedStorage:FindFirstChild("Gamepass")
    if gamepass then
        local playerDataUpdated = gamepass:FindFirstChild("PlayerDataUpdated")
        if playerDataUpdated and playerDataUpdated:IsA("RemoteEvent") then
            playerDataUpdated.OnServerEvent:Connect(function(player, ...)
                -- Rate limit
                if not CheckRateLimit(player) then
                    HandleViolation(player)
                    return
                end
                
                Log(string.format("%s triggered PlayerDataUpdated", player.Name), "INFO")
            end)
            
            Log("‚úÖ Protected: PlayerDataUpdated", "INFO")
        end
    end
end

-- ============================================
-- ANTI-SPAM PROTECTION
-- ============================================

local function SetupAntiSpam()
    Log("üõ°Ô∏è Setting up Anti-Spam Protection...", "INFO")
    
    -- Monitor all remotes for spam
    for _, remote in pairs(ReplicatedStorage:GetDescendants()) do
        if remote:IsA("RemoteEvent") then
            remote.OnServerEvent:Connect(function(player)
                local data = GetPlayerData(player)
                data.RequestCount = data.RequestCount + 1
            end)
        end
    end
end

-- ============================================
-- CLEANUP
-- ============================================

Players.PlayerRemoving:Connect(function(player)
    PlayerData[player] = nil
end)

-- ============================================
-- INITIALIZE
-- ============================================

print("\n" .. string.rep("=", 60))
Log("MUSIC SYSTEM ANTI-CHEAT INITIALIZING...", "INFO")
print(string.rep("=", 60))

-- Setup protections
wait(1)  -- Wait for game to load

ProtectMusicSystem()
wait(0.5)

ProtectMusicRemotes()
wait(0.5)

ProtectAdminRemotes()
wait(0.5)

ProtectGamepassRemotes()
wait(0.5)

SetupAntiSpam()

-- Initialize tracking untuk semua player
for _, player in pairs(Players:GetPlayers()) do
    GetPlayerData(player)
end

print(string.rep("=", 60))
Log("‚úÖ MUSIC SYSTEM ANTI-CHEAT ACTIVE!", "INFO")
Log(string.format("Protected Admins: %d", #CONFIG.ADMIN_USER_IDS + 1), "INFO")
print(string.rep("=", 60))
